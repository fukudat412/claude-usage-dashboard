# Development Dockerfile for Rust backend with hot reload
# cargo-watchを使用したホットリロード対応の開発環境

FROM rust:1.83-alpine

# Install dependencies for development
RUN apk add --no-cache \
    musl-dev \
    openssl-dev \
    pkgconfig

# Install inotify-tools for file watching
RUN apk add --no-cache inotify-tools

WORKDIR /app

# Copy Cargo files
COPY Cargo.toml Cargo.lock ./

# Create dummy main.rs to build dependencies
RUN mkdir src && \
    echo "fn main() {}" > src/main.rs && \
    cargo build && \
    rm -rf src

# Copy source code (will be mounted as volume in docker-compose)
COPY src ./src

EXPOSE 8080

# Environment variables for development
ENV RUST_LOG=debug
ENV PORT=8080
ENV RUST_BACKTRACE=1

# Simple hot reload script using inotifywait
CMD ["sh", "-c", "while true; do cargo run & PID=$!; inotifywait -r -e modify,create,delete src && kill $PID 2>/dev/null || true; wait $PID 2>/dev/null || true; sleep 1; done"]
