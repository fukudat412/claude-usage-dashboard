# Docker Compose configuration with Rust backend
# マルチコンテナ構成（アプローチB）: 最も軽量で推奨

version: '3.8'

services:
  # Rust Backend Service (Ultra-lightweight ~15MB)
  rust-backend:
    build:
      context: ./rust-backend
      dockerfile: Dockerfile
    container_name: claude-rust-backend
    environment:
      - RUST_LOG=info
      - PORT=8080
      - PROJECTS_PATH=/root/.claude/projects
    volumes:
      # Claude configuration (read-only)
      - ~/.claude:/root/.claude:ro
      # MCP logs (read-only)
      - ~/Library/Caches/claude-cli-nodejs:/root/Library/Caches/claude-cli-nodejs:ro
      # VS Code extension data (read-only)
      - ~/Library/Application Support/Code:/root/Library/Application Support/Code:ro
    networks:
      - claude-network
    restart: unless-stopped
    # Note: distroless doesn't support healthcheck with shell commands
    # Health checks are handled by the node-proxy service

  # Node.js Proxy Service
  node-proxy:
    build:
      context: .
      dockerfile: Dockerfile.proxy
    container_name: claude-node-proxy
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - PORT=3001
      - LOG_LEVEL=info
      - USE_RUST_BACKEND=true
      - RUST_BACKEND_URL=http://rust-backend:8080
    depends_on:
      - rust-backend
    networks:
      - claude-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/api/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  claude-network:
    driver: bridge

# Usage:
# Build and start: docker-compose -f docker-compose.rust.yml up -d
# Stop: docker-compose -f docker-compose.rust.yml down
# Logs: docker-compose -f docker-compose.rust.yml logs -f
# Rebuild: docker-compose -f docker-compose.rust.yml up -d --build
